(()=>{let t;(()=>{const e="__app_sdc",s="production",n=!1;if(t=globalThis[e],t)return;const r={name:e,env:s,get:t=>t in r?r[t]:null,...JSON.parse('{"version":"9.2.1"}')},i=function t(e){const s=e===r,i=s&&n,l={},c=t=>Object.assign(e,t),h=new Proxy(e,{get(n,r){if("assign"===r)return c;if(s&&!String(r).startsWith("$"))return e[r];if(!(r in e)){if(e[r]={},s){const t=o.bind(null,"log",r,!1),s=o.bind(null,"log",r,!0),n=o.bind(null,"warn",r,!1),i=o.bind(null,"warn",r,!0),l=o.bind(null,"error",r,!1),c=o.bind(null,"error",r,!0),h=a.bind(null,r);Object.defineProperties(e[r],{log:{get:()=>t},logDev:{get:()=>s},warn:{get:()=>n},warnDev:{get:()=>i},error:{get:()=>l},errorDev:{get:()=>c},Error:{get:()=>h}})}l[r]=t(e[r]),i&&(globalThis[r]=e[r])}return r in l?l[r]:e[r]},set:(t,s,n)=>(e[s]=n,l[s]=n,i&&(globalThis[s]=e[s]),!0)});return h}(r);function o(t,e,s,...n){if(s)return;const[r,i,o]=function(t){let e=0;t.split("").forEach(((s,n)=>{e=t.charCodeAt(n)+((e<<5)-e)}));return[(16711680&e)>>16,(65280&e)>>8,255&e]}(e);console[t](`%c[${e}]`,`color: rgb(${r}, ${i}, ${o})`,...n)}function a(t,e,...s){return s.length>0&&o("error",t,!1,e,...s),new Error(`[${t}] ${e}`)}globalThis[e]=i,t=i})(),(()=>{const{$bus:e,$env:s,$utils:n}=t;{const e=t.get("$bus").controller?._njOnMsg;e&&window.removeEventListener("message",e)}e.controller={init(){e.on=this.on.bind(this),e.off=this.off.bind(this),e.once=this.once.bind(this),e.send=this._wrapThrowIfError(this.send),e.call=this._wrapThrowIfError(this.call),e.poll=this.poll.bind(this),e.getTabId=this.getTabId.bind(this),e.getWindowId=this.getWindowId.bind(this),this._locus=s.getLocus(),this._serialize=this._serialize.bind(this),this._handlers={},this._is("pp")?this._setupPp():this._is("bg")?(this._blobs={},this._channel=new BroadcastChannel("bus.channel"),this._setupBg()):this._is("cs")?this._setupCs():this._is("nj")?this._setupNj():this._is("os")?(e.setIframe=t=>this._iframe=t,this._iframe=null,this._channel=new BroadcastChannel("bus.channel"),this._setupOs()):this._is("oi")&&this._setupOi()},on(t,e,s=null){this._on(t,null,e,s)},off(t,e=null){this._off(t,null,e)},once(t,e){const s=async(...n)=>(this.off(t,s),await e(...n));this.on(t,s)},async send(t,...s){if(!n.is.nan(Number(t))){const e=Number(t);return t=s[0],s=s.slice(1),await this._sendToTab(e,t,...s)}if(this._is("pp"))return await this._sendToExt(t,...s);if(this._is("nj"))return await this._sendToPage(t,...s);if(this._is("oi"))return await this._sendToParent(t,...s);if(this._is("bg","cs","os"))return await this._pick([this._sendToExt(t,...s),this._callHandlers({name:t,args:s},(t=>t.proxy))]);if(this._is("fg")){if("store.actions"===t)return;if("idb.change"===t)return;e.log(t,...s)}},async call(t,...e){return this._callHandlers({name:t,args:e},(t=>!t.proxy))},async poll(t,...e){return await n.waitFor((()=>this.send(t,...e)))},async getTabId(){if(this._is("bg"))return null;const{tabId:t}=await this.send("bus.getTabData");return t},async getWindowId(){if(this._is("bg"))return null;const{windowId:t}=await this.send("bus.getTabData");return t},_on(t,e,s,n=null){this._handlers[t]||(this._handlers[t]=[]),this._is("cs","nj","oi")&&0===this._handlers[t].length&&this._sendToProxier("bus.proxy",t,!0);const r={fn:s,name:t};e&&(r.proxy=e),n&&(r.this=n),this._handlers[t].push(r)},_off(t,e=null,s=null){this._handlers[t]&&(this._handlers[t]=this._handlers[t].filter((t=>{const n=!s||s===t.fn,r=e===(t.proxy||null);return!n||!r})),this._is("cs","nj","oi")&&0===this._handlers[t].length&&this._sendToProxier("bus.proxy",t,!1))},_setupPp(){},_setupBg(){},_setupCs(){},_setupNj(){this._njOnMsg=async({data:t})=>{if(!t?.$bus)return;if("cs"!==t.locus)return;const e=await this._callHandlers(t);window.postMessage({resId:t.reqId,result:e},"*")},window.addEventListener("message",this._njOnMsg)},_setupOs(){},_setupOi(){},async _sendToExt(t,...s){const n={$bus:!0,name:t,argsStr:this._serialize(s)},r=await new Promise((t=>{try{chrome.runtime.sendMessage(n,(e=>{chrome.runtime.lastError?t(null):t(e)}))}catch(s){if("Extension context invalidated."===s.message)return;e.error(s),t(null)}}));return await this._deserialize(r)},async _sendToTab(t,e,...s){if(!chrome.tabs?.sendMessage)return await this.send("bus.sendToTab",t,e,...s);const n={$bus:!0,name:e,argsStr:this._serialize(s)},r=await new Promise((e=>{chrome.tabs.sendMessage(t,n,(t=>{chrome.runtime.lastError?e(null):e(t)}))}));return await this._deserialize(r)},async _sendToPage(t,...e){const s=this._generateId(),n={$bus:!0,name:t,args:e,reqId:s,locus:this._locus};return window.postMessage(n,"*"),await this._waitForResponseMessage(s)},async _sendToIframe(t,...e){if(!this._iframe)return null;const s=this._generateId(),n={$bus:!0,name:t,args:e,reqId:s};return this._iframe.contentWindow.postMessage(n,"*"),await this._waitForResponseMessage(s)},async _sendToParent(t,...e){const s=this._generateId(),n={$bus:!0,name:t,args:e,reqId:s};return parent.postMessage(n,"*"),await this._waitForResponseMessage(s)},async _sendToProxier(t,...e){return this._is("cs")?await this._sendToExt(t,...e):this._is("nj")?await this._sendToPage(t,...e):this._is("oi")?await this._sendToParent(t,...e):void 0},_waitForResponseMessage:async t=>await new Promise((e=>{const s=({data:n})=>{!(!n||n.resId!==t)&&(window.removeEventListener("message",s),e(n.result))};window.addEventListener("message",s)})),_callHandlers({name:t,args:s,argsStr:n},r=null){let i=this._handlers[t];return i?(r&&(i=i.filter(r)),0===i.length?null:new Promise((async t=>{n&&(s=await this._deserialize(n));t(await this._pick(i.map((async t=>{try{return await t.fn.call(t.this,...s)}catch(s){return e.error(`failed to handle "${t.name}".`,s),s}}))))}))):null},_serialize(t){return n.is.nil(t)?null:JSON.stringify(t,((t,e)=>{if(n.is.blob(e)){if(this._is("bg")){const t=this._generateId();return this._blobs[t]=e,`bus.blob.${t}`}return`bus.blob.${n.objectUrl.create(e,!0)}`}return n.is.error(e)?`bus.error.${e.message}`:e}))},async _deserialize(t){if(!n.is.string(t))return null;const e=new Map,s=JSON.parse(t,((t,s)=>{const r=n.is.string(s);return r&&s.startsWith("bus.blob.")?(e.set(s,s.slice("bus.blob.".length)),s):r&&s.startsWith("bus.error.")?new Error(s.slice("bus.error.".length)):s}));return await Promise.all([...e.keys()].map((async t=>{let s;const n=e.get(t);s=n.startsWith("blob:")?n:await this._sendToExt("bus.blobIdToObjectUrl",n);const r=await fetch(s).then((t=>t.blob()));e.set(t,r)}))),this._applyBlobs(s,e)},_applyBlobs(t,e){if(e.has(t))return e.get(t);if(n.is.array(t)||n.is.object(t))for(const s in t)t[s]=this._applyBlobs(t[s],e);return t},async _blobIdToObjectUrl(t){},async _blobToObjectUrl(t){},_is(...t){return t.includes(this._locus)},_generateId:()=>`bus-${Date.now()}-${Math.random().toString(36).slice(2)}`,_wrapThrowIfError(t){return async(...e)=>{const s=await t.call(this,...e);if(n.is.error(s))throw s;return s}},_pick:async(t=[])=>0===t.length?null:await new Promise((e=>{let s=0;t.forEach((async r=>{const i=await r;return n.is.nil(i)?s===t.length-1?e(null):void s++:e(i)}))}))}})(),(()=>{const{$utils:e}=t;e.createPromise=()=>{let t=null,e=null;const s=new Promise(((s,n)=>{t=s,e=n}));return Object.defineProperty(s,"resolve",{get:()=>t}),Object.defineProperty(s,"reject",{get:()=>e}),s}})(),(()=>{const{$utils:e}=t;e.isTopFrame=()=>window.top===window})(),(()=>{const{$utils:e}=t;e.is={null:t=>null===t,defined:t=>void 0!==t,undefined:t=>void 0===t,nil:t=>null==t,boolean:t=>"boolean"==typeof t,number:t=>"number"==typeof t,string:t=>"string"==typeof t,symbol:t=>"symbol"==typeof t,function:t=>"function"==typeof t,map:t=>t instanceof Map,set:t=>t instanceof Set,url:t=>t instanceof URL,blob:t=>t instanceof Blob,file:t=>t instanceof File,error:t=>t instanceof Error,regexp:t=>t instanceof RegExp,array:t=>Array.isArray(t),object:t=>"[object Object]"===Object.prototype.toString.call(t),nan:t=>Number.isNaN(t),nonPrimitive:t=>e.is.object(t)||e.is.array(t),numeric:t=>!e.is.nan(Number(t)),empty:t=>!!e.is.nil(t)||(e.is.array(t)?0===t.length:e.is.object(t)?0===Object.keys(t).length:!!e.is.string(t)&&0===t.trim().length)}})(),(()=>{const{$utils:e,$bus:s}=t;e.objectUrl={create(t,n=!1){if(!URL.createObjectURL)return s.send("utils.objectUrl.create",t,n);const r=URL.createObjectURL(t);if(n){const t=e.is.number(n)?n:6e4;setTimeout((()=>URL.revokeObjectURL(r)),t)}return r},revoke(t){if(!URL.revokeObjectURL)return s.send("utils.objectUrl.revoke",t);URL.revokeObjectURL(t)}}})(),Array.prototype.toReversed&&(Array.prototype.toReversed=function(){return[...this].reverse()}),Array.prototype.at||(Array.prototype.at=function(t){return this[t>=0?t:this.length+t]}),Array.prototype.findLastIndex||(Array.prototype.findLastIndex=function(t,e){for(let s=this.length-1;s>=0;s--)if(t.call(e,this[s],s,this))return s;return-1}),String.prototype.replaceAll&&/\{\s+\[native code]/.test(Function.prototype.toString.call(String.prototype.replaceAll))||(String.prototype.replaceAll=function(t,e){return"[object regexp]"===Object.prototype.toString.call(t).toLowerCase()?this.replace(t,e):this.replace(new RegExp(t,"g"),e)}),(()=>{const{$utils:e}=t;e.sleep=async t=>new Promise((e=>{setTimeout(e,t)}))})(),(()=>{const{$utils:e}=t;e.waitFor=async(t,{interval:s=100,timeout:n=6e4}={})=>{if(n<=0)throw new Error("$utils.waitFor: timeout exceeded");const r=Date.now(),i=await t();if(i)return i;await e.sleep(s);const o=Date.now()-r;return e.waitFor(t,{interval:s,timeout:n-o})}})(),(()=>{const{$env:e}=t;e.getLocus=()=>{if("undefined"==typeof location)return"el";const{protocol:t,host:e,pathname:s,href:n}=location;return"https://harpa.ai/oi"===n||"http://localhost:3000/oi"===n?"oi":"chrome-extension:"!==t&&chrome?.runtime?.getURL?"cs":"localhost:3050"===e?"fg":"chrome-extension:"!==t?"nj":"/harpa.html"===s?"pp":"/offscreen.html"===s?"os":"bg"}})(),(()=>{const{$startup:e,$bus:s,$utils:n}=t;e.controller={async init(){this._root=document.querySelector("__hrp__"),this._initPromise=n.createPromise(),await s.controller.init(),this._initPromise.resolve(),e.logDev("nj ready")},async waitInit(){await this._initPromise},getRootElement(){return this._root}},e.controller.init()})()})();