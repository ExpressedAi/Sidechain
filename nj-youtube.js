(()=>{let t;(()=>{const e="__app_hrp",i="production",s=!1;if(t=globalThis[e],t)return;const n={name:e,env:i,get:t=>t in n?n[t]:null,...JSON.parse('{"version":"9.2.1"}')},o=function t(e){const i=e===n,o=i&&s,d={},h=t=>Object.assign(e,t),l=new Proxy(e,{get(s,n){if("assign"===n)return h;if(i&&!String(n).startsWith("$"))return e[n];if(!(n in e)){if(e[n]={},i){const t=r.bind(null,"log",n,!1),i=r.bind(null,"log",n,!0),s=r.bind(null,"warn",n,!1),o=r.bind(null,"warn",n,!0),d=r.bind(null,"error",n,!1),h=r.bind(null,"error",n,!0),l=a.bind(null,n);Object.defineProperties(e[n],{log:{get:()=>t},logDev:{get:()=>i},warn:{get:()=>s},warnDev:{get:()=>o},error:{get:()=>d},errorDev:{get:()=>h},Error:{get:()=>l}})}d[n]=t(e[n]),o&&(globalThis[n]=e[n])}return n in d?d[n]:e[n]},set:(t,i,s)=>(e[i]=s,d[i]=s,o&&(globalThis[i]=e[i]),!0)});return l}(n);function r(t,e,i,...s){if(i)return;const[n,o,r]=function(t){let e=0;t.split("").forEach(((i,s)=>{e=t.charCodeAt(s)+((e<<5)-e)}));return[(16711680&e)>>16,(65280&e)>>8,255&e]}(e);console[t](`%c[${e}]`,`color: rgb(${n}, ${o}, ${r})`,...s)}function a(t,e,...i){return i.length>0&&r("error",t,!1,e,...i),new Error(`[${t}] ${e}`)}globalThis[e]=o,t=o})(),(()=>{const{$yousummary:e,$bus:i}=t;e.controller={init(){top.self===self&&(this.startObserver=this.startObserver.bind(this),this.stopObserver=this.stopObserver.bind(this),this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.appendSummary=this.appendSummary.bind(this),i.on("yousummary.append-summary",this.appendSummary),document.hidden?this.stopObserver():this.startObserver(),document.addEventListener("visibilitychange",this.handleVisibilityChange))},appendSummary(t){this.summary?.local?this.summary.content+="\n\n"+t:this.summary={local:!0,content:t};this.computePoi(this.summary)&&(this.summary.content=t),this.applyPosition()},startObserver(){if(this.tooltip||this.observer||document.hidden)return;this.observer=new MutationObserver((t=>{if(!t?.some((t=>t.addedNodes.length)))return;const e=document.querySelector("#ytd-player .ytp-tooltip .ytp-tooltip-edu > span");if(!e)return;const i=document.querySelector("ytd-watch-flexy");if(!i)return;const s=document.querySelector(".ytp-tooltip-text");e.__ys_patched||(e.__ys_patched=!0,this.nodeTooltip=e,this.nodeVideo=i,this.nodePosition=s,this.patchTooltip())})),this.observer.observe(document.documentElement,{childList:!0,subtree:!0})},stopObserver(){this.observer&&(this.observer.disconnect(),this.observer=null)},handleVisibilityChange(){document.hidden?this.stopObserver():this.startObserver()},patchTooltip(){this.stopObserver(),document.removeEventListener("visibilitychange",this.handleVisibilityChange);const t=this.nodeTooltip.parentElement;t.removeChild(this.nodeTooltip);const e=document.createElement("style");e.innerText="#poi{max-width:236px;margin-right:7px;border-radius:6px;padding:4px 6px}.ytp-fullscreen #poi{margin-right:9px;max-width:358px}#poi.loaded{text-align:left;background:rgba(0,0,0,.5);margin-bottom:4px}#poi .poi-content{font-weight:400;margin-top:8px}#poi .poi-hidden{display:none}",t.appendChild(e),this.poi=document.createElement("div"),this.poi.id="poi";const i=document.createElement("div");i.classList.add("poi-title"),this.poi.appendChild(i);const s=document.createElement("div");s.classList.add("poi-content"),this.poi.appendChild(s),t.appendChild(this.poi),this.watchPositionChange(),this.watchVidChanges()},watchVidChanges(){new MutationObserver((t=>{const e=t.find((t=>"attributes"===t.type&&"video-id"===t.attributeName));if(!e)return;const i=e.target.getAttribute("video-id");this.loadSummary(i)})).observe(this.nodeVideo,{attributes:!0}),this.loadSummary(this.nodeVideo.getAttribute("video-id"))},watchPositionChange(){new MutationObserver((t=>{const e=t.find((t=>"childList"===t.type));if(!e)return;const i=e.target.textContent.trim();this.updatePosition(i)})).observe(this.nodePosition,{childList:!0,subtree:!0}),this.updatePosition(this.nodePosition.textContent)},updatePosition(t){t&&this.positionText!==t&&(this.positionText=t,t=t.split(":"),this.position=(parseInt(t.at(-1),10)||0)+60*(parseInt(t.at(-2),10)||0)+3600*(parseInt(t.at(-3),10)||0),this.applyPosition())},async loadSummary(t){this.summary=null,this.applyPosition();const e=await i.send("yousummary.get-summary",t);e&&this.appendSummary(e)},computePoi(t){const e=/^\s*-\s+/,i=(t.content||"").split("\n"),s=[];let n=null;for(let t of i){""===t&&(t="\n");const i=/^\s*(- )?\[(?<hour>\d\d?:)?(?<minute>\d\d?):(?<second>\d\d?)](?<url>\(.+\))\s?(?<text>.+)/gm.exec(t);i?(n&&s.push(n),n={ts:0,text:""},n.ts=3600*(parseInt(i.groups.hour)||0)+60*(parseInt(i.groups.minute)||0)+(parseInt(i.groups.second)||0),n.text=i.groups.text):n&&(t=t.replace(e," â€¢ "),n.text+=t+"\n")}n&&s.push(n),s.forEach((t=>t.text=t.text.trim()));let o=0,r=Number.MAX_SAFE_INTEGER;for(let t=s.length-1;t>=0;t--){if(s[t].ts>r){o=t+1;break}r=s[t].ts}return t.poi=s.slice(o),o>0},applyPosition(){if(!this.poi)return;const t=this.summary?.poi?.findLast((t=>t.ts<=this.position));if(t){const e=t.text.split("\n"),i=e[0];this.poi.childNodes[0].innerText=i;const s=e.slice(1).join("\n").trim();this.poi.childNodes[1].innerText=s,this.poi.classList.add("loaded")}else this.poi.childNodes[0].innerText="Summarize with HARPA to show key points",this.poi.childNodes[1].innerText="",this.poi.classList.remove("loaded");this.poi.childNodes[1].classList.toggle("poi-hidden",!this.poi.childNodes[1].innerText)}}})(),(()=>{const{$startup:e,$yousummary:i}=t;e.youtubeController={async init(){await e.controller.waitInit(),await i.controller.init(),e.logDev("nj-youtube ready")}},e.youtubeController.init()})()})();